# ESP32端控制命令协议指导

ROS端发送数据格式：“TPY:XXX TPP:XXX TVY:XXX TVP:XXX TE:XX TPID:XX TD:XX”
其中：

- TPY：控制 Yaw 轴电机的目标角度，单位为度，控制限制范围为 **[-720, 720]**
- TPP：控制 Pitch 轴电机的目标角度，单位为度，控制限制范围为 **[-180, 180]**
- TVY：控制 Yaw 轴电机的角速度，单位为度/秒，允许值为 **[-720, -36] ∪ {0} ∪ [36, 720]**，即非零速度绝对值在 [36, 720]
- TVP：控制 Pitch 轴电机的角速度，单位为度/秒，允许值同上 **[-720, -36] ∪ {0} ∪ [36, 720]**
- TE：控制 Yaw 轴和 Pitch 轴电机使能，取值 00,01,10,11，**0 为使能，1 为失能，高位为 Yaw，低位为 Pitch**
- TPID：预留给 PID 串环控制的模式标志，**当前实现中仅用于安全保护**：
  - 当 TPID 为 0 且 MPU 姿态传感器状态异常时，本次命令会被忽略并强制两轴停机；
  - 当 TPID 为 0 且 MPU 正常时，当前固件仍按“开环角度/速度控制”执行（PID 算法接口已预留，暂未启用）；
  - 当 TPID 为其它值或该字段缺省时，按普通开环控制处理。
- TD：保留位，当前解析后仅记录，不参与控制。

## 控制协议

1. **速度控制模式（TVY/TVP 生效）**  
   - 当某轴未显式下发 TPY/TPP（即无该字段或字段为空），但下发了 TVY/TVP 且数值为非零时，该轴为“速度控制模式”；  
   - 速度为负时，仅通过方向 IO（DIR 引脚）翻转方向，PWM 频率按速度绝对值计算；  
   - 速度字段存在且数值为 0 时，视为显式“停机”指令（若无角度命令）。

2. **角度控制模式（TPY/TPP 优先）**  
   - 当 TPY 或 TPP 字段有数值（包括 0）时，对应电机进入“角度控制模式”，**角度控制优先于速度控制**；  
   - 角度为负时，仅通过方向 IO 翻转方向，目标脉冲数按角度绝对值计算；  
   - 若同时下发 TVY/TVP，则在角度模式下使用该速度驱动电机到目标角度；  
   - 若 TVY/TVP 字段存在但数值为 0，则在角度模式下默认速度为 **90 deg/s**；  
   - 若 TPY 或 TPP 为 0，则表示目标角度为 0°（回零）；若完全不下发该字段，则不进入角度模式。

3. **脉冲生成与模式切换实现方式（当前实现）**  
    - 速度控制与角度控制均使用 **同一组 LEDC PWM 定时器 + 通道** 在对应轴的 PUL 引脚输出脉冲；  
    - **速度控制模式**：
       - 根据 TVY/TVP 设定的目标角速度，调用 `yaw_set_speed_deg_per_sec` / `pitch_set_speed_deg_per_sec`，
          按线性关系 `360deg/s -> 20kHz` 计算并配置 LEDC 频率；
       - 启动 `*_pul_start()` 后，LEDC 在该频率下连续输出方波，形成恒速旋转。  
    - **角度控制模式**（TPY/TPP 生效、优先级高于速度）：
       - 根据 TPY/TPP 计算目标脉冲数：`target_pulses = (10000/180) * |angle_deg|`；
       - 根据 TVY/TVP（或默认 90deg/s）再次调用 `*_set_speed_deg_per_sec`，
          设置当前角度动作所需的 PWM 频率，并读取实际配置到 LEDC 的频率 `freq_hz`；
       - 启动 `*_pul_start()`，以该频率连续输出 PWM 脉冲；
       - 同时启动一个低频 `esp_timer`（周期约 1ms），在回调中按 `freq_hz * dt` 积分“理论脉冲数”，
          当累计脉冲数达到或略超过 `target_pulses` 时，自动停止 PWM 输出和定时器，实现定角停止；
       - 由于积分周期较长（ms 级），CPU 负载远低于过去的“高频翻转 GPIO”方案，
          在 `TVY/TVP` 较大、且 **Yaw/Pitch 同时角度控制** 时仍能稳定工作。  
    - 从速度控制切换为角度控制、或从角度控制回到速度控制时，固件会先停止当前 PWM 输出，再按新模式重新配置频率和定时器，
       保证同一 IO 上始终只存在一个脉冲源，不会出现模式叠加。

4. **引脚定义与方向约定**  
   - YAW_DIR：控制 Yaw 轴电机方向电平（DIR），对应 GPIO2；  
   - YAW_PUL：控制 Yaw 轴电机运动脉冲（PUL），对应 GPIO3；  
   - PITCH_DIR：控制 Pitch 轴电机方向电平（DIR），对应 GPIO10；  
   - PITCH_PUL：控制 Pitch 轴电机运动脉冲（PUL），对应 GPIO6；  
   - Yaw 从上往下看逆时针为正方向；  
   - Pitch 从轴往机座看，逆时针为正方向；  
   - 协议中角度/速度的正负号仅决定 DIR 引脚电平方向，PWM 频率始终按绝对值计算。

5. **速度与角度的标定关系**  
   - 当速度为 **360 度/秒** 时，对应脉冲输出频率为 **20 kHz**；  
   - 固件内部使用线性映射：`freq = 20000 * |speed_deg| / 360`，并对结果做上下限饱和（100 Hz ~ 40 kHz）；  
   - 当角度为 **180°** 时，对应脉冲输出个数为 **10000 个**，内部按线性比例 `pulses_per_deg = 10000/180` 计算目标总脉冲数；  
   - 角度控制模式下目标速度建议不低于 **36 deg/s**，否则由于电机、减速比等机械特性，可能出现明显超转。
